define(["require","exports","tslib","react","lodash","classnames","typescript/libraries/comments2/src/components/thread/index","typescript/libraries/comments2/src/components/comment_stream/comment_stream_post_bar","typescript/libraries/comments2/src/components/comment/index","typescript/libraries/comments2/src/components/comment_editor/comment_utils","typescript/libraries/comments2/src/components/comment_editor/comment_editor","typescript/libraries/comments2/src/components/types/index","prop-types","typescript/libraries/comments2/src/components/comment_stream/unread_pill_wrapper","typescript/libraries/comments2/src/components/utils/calc_visibility_data","typescript/libraries/comments2/src/components/utils/visibility_aware_scroll_list","typescript/libraries/comments2/src/components/comment_editor/draft_utils","spectrum/tooltip/index","spectrum/icon_global/index","typescript/libraries/comments2/src/components/coachmark_location/index","typescript/libraries/comments2/src/components/comment_stream/cloud_doc_message","typescript/libraries/comments2/src/components/comment_stream/first_party_comment_advisory","typescript/libraries/comments2/src/components/types/index","react-intl","dig-components/typography"],(function(e,t,o,s,a,i,r,n,c,d,m,l,h,p,u,C,E,v,g,b,f,y,k,A,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.CommentStream=void 0,s=o.__importStar(s),i=o.__importDefault(i),d=o.__importStar(d),h=o.__importDefault(h);const T=()=>{},M=A.defineMessage({id:"XI84a1",defaultMessage:"Comments on this file will show up here."});class R extends s.PureComponent{constructor(e){super(e),this.threadIdToRef={},this.editorHasChanges={},this.onThreadInteractedWith=e=>{const{activeThreadID:t,collapsed:o,actionsAdapter:{onThreadActivated:s,onInteractionWhileCollapsed:a}}=this.props;o&&a&&a(l.CollapsedInteraction.AVATAR_CLICK),t!==e.id&&s(e)},this.onVisibilityDataChange=e=>{this.setState({visibilityData:e})},this.updateTrackedItems=()=>{var e,t;this.setState({trackedItems:(e=this.props.threads,t=this.threadIdToRef,e.map(e=>({item:e,ref:t[e.id]})).filter(({item:e,ref:t})=>!e.read&&t))})},this.createUpdateCoachmarkPosition=e=>t=>{this.setState(o=>b.areCoachmarkPositionsEqual(this.state.coachmarkPositions[e],t)?null:{coachmarkPositions:Object.assign(Object.assign({},o.coachmarkPositions),{[e]:t})})},this.coachmarkPropsCache={},this.onStartEdit=e=>{this.setState({editedComment:e})},this.onEndEdit=()=>{this.setState({editedComment:void 0})},this.onLeaveACommentClick=()=>{const{collapsed:e,actionsAdapter:{onInteractionWhileCollapsed:t}}=this.props;e&&(t&&t(l.CollapsedInteraction.LEAVE_COMMENT_CLICK),this.focusPrimaryEditor())},this.setDraftRef=e=>{this.draftRef=e},this.setThreadRef=(e,t)=>{this.threadIdToRef[e]=t&&t.innerRef},this.handleClick=e=>{e.target.classList.contains("sc-comment-stream-threads")&&(this.props.actionsAdapter.onAllThreadsDeactivated(),this.editorHasChanges.PRIMARY||this.props.actionsAdapter.onCommentDraftCancel())},this.onThreadReplyCancel=()=>{this.props.actionsAdapter.onAllThreadsDeactivated()},this.onPrimaryEditorCancel=()=>{document.activeElement&&this.blurElement(document.activeElement),this.props.actionsAdapter.onCommentDraftCancel(),this.setState({content:d.createEmptyContent(),editedComment:void 0})},this.onPrimaryEditorFocus=()=>{this.props.actionsAdapter.onAllThreadsDeactivated(),this.props.actionsAdapter.onEditorFocused()},this.onEditorStateChange=e=>t=>{this.editorHasChanges[e]=!E.contentIsEmpty(t)},this.onPrimaryEditorStateChange=e=>{this.onEditorStateChange("PRIMARY")(e),this.props.actionsAdapter.onEditorStateChange(e)},this.hasUnsavedChanges=()=>{const{threads:e}=this.props;return this.editorHasChanges.PRIMARY||e.some(e=>this.editorHasChanges[e.id]||!!e.pending)||void 0!==this.state.editedComment},this.promptBeforeCloseHandler=e=>{if(this.hasUnsavedChanges())return e.returnValue="",e.preventDefault(),""},this.createThreadActions=e=>{const{onCommentDeleted:t,onCommentEdited:o,onClickAnnotation:s,onEditorFocused:a,onMentionsQueryUpdated:i,onThreadMarkedAsRead:r,onThreadMarkedAsUnread:n,onThreadRepliedTo:c,onThreadResolved:d,onThreadUnresolved:m,onThreadMouseEnter:l=T,onThreadMouseLeave:h=T,onThreadFocus:p=T,onThreadBlur:u=T,onClickOlderInfo:C=T,onApproverRespond:E,onEditApproval:v,onDeleteApprovalComment:g,onResubmitApprovalFocus:b,onResubmitApprovalBlur:f,onResubmitApprovalRequest:y,onRemoveApprovalThread:k}=this.props.actionsAdapter;return{onClickAnnotation:s,onReply:t=>c(e,t),onMarkAsRead:()=>r(e),onMarkAsUnread:()=>n(e),onResolve:()=>d(e),onUnresolve:()=>m(e),onMouseEnter:()=>l(e),onMouseLeave:()=>h(e),onFocus:()=>p(e),onBlur:()=>u(e),onEditorFocused:()=>a(e),onCommentDeleted:o=>t(o,e),onCommentEdited:(t,s)=>o(t,s,e),onMentionsQueryUpdated:i,onClickOlderInfo:C,onEditorStateChange:this.onEditorStateChange(e),onApproverRespond:()=>E(e),onEditApproval:t=>v(e,t),onDeleteApprovalComment:(t,o)=>g(t,e,o),onResubmitApprovalFocus:()=>b(e),onResubmitApprovalBlur:f,onResubmitApprovalRequest:t=>y(e,t),onRemoveApprovalThread:()=>k(e)}},this.renderPostBar=s.memo(e=>s.createElement(n.CommentStreamPostBar,Object.assign({coachmarkTargetProps:this.createCoachmarkProps("target")},e))),this.state={content:d.createEmptyContent(),editedComment:void 0,visibilityData:u.createEmptyVisibilityData(),trackedItems:[],coachmarkPositions:{location:null,target:null},context:{useV2Design:e.useDesignV2,showApproval:e.showApproval}}}getChildContext(){return{localization:this.props.localization,useV2Design:!!this.props.useDesignV2,showApproval:!!this.props.showApproval}}createCoachmarkProps(e){if(e in this.coachmarkPropsCache)return this.coachmarkPropsCache[e];const t=this.props.coachmarkData||{component:()=>null},o=Object.assign(Object.assign({},t),{updatePosition:this.createUpdateCoachmarkPosition(e),positions:this.state.coachmarkPositions});return this.coachmarkPropsCache[e]=o,o}clearCachedCoachmarkProps(){this.coachmarkPropsCache={}}componentDidMount(){window.addEventListener("beforeunload",this.promptBeforeCloseHandler),this.updateTrackedItems()}componentDidUpdate({threads:e}){this.props.threads!==e&&this.updateTrackedItems()}get sortedThreads(){const[e,t]=a.partition(this.props.threads,"isThirdParty");return[...e,...t]}get sortedVisibleThreads(){return!this.includeEditorMeatball&&!this.props.useDesignV2||this.props.showResolvedComments?this.sortedThreads:this.sortedThreads.filter(e=>!(e.resolved||e.resolvedInfo))}componentWillUnmount(){window.removeEventListener("beforeunload",this.promptBeforeCloseHandler)}UNSAFE_componentWillReceiveProps(e){e.coachmarkData!==this.props.coachmarkData&&(this.clearCachedCoachmarkProps(),this.setState({coachmarkPositions:{location:null,target:null}}))}focusPrimaryEditor(){this.draftRef&&this.draftRef.focusEditor()}blurElement(e){let t;"function"==typeof Event?t=new FocusEvent("blur"):(t=document.createEvent("Event"),t.initEvent("blur",!0,!0)),e.dispatchEvent(t)}get includeEditor(){const{isMobile:e,settings:t}=this.props;return t.canShowEditor&&!e}get includeEditorMeatball(){const{settings:e}=this.props;return this.includeEditor&&e.canShowEditorMeatball}render(){const{actionsAdapter:{onMentionsQueryUpdated:e,onThreadCreated:t},className:o="",commentComponent:a=(e=>s.createElement(c.Comment,Object.assign({},e))),editorComponent:n=(e=>s.createElement(m.CommentEditor,Object.assign({},e))),enabled:d,user:l,mentionsMatches:h,activeThreadID:u,hoverThreadID:E,focusedThreadID:T,isGoogleDSS:R,isMobile:_,localization:{intl:D},collapsed:S=!1,coachmarkData:I,placeholderOverride:w,settings:F,showRevisionInfo:O,stickerPacks:U,thirdPartySource:V,initialEditorFocus:L,hideOpenCloudDocMessage:x,useDesignV2:N,meatballMenu:W}=this.props,B=i.default(o,{"sc-comment-stream":!0,"sc-comment-stream--right-rail":!!N,"sc-comment-stream-enabled":d,"sc-comment-stream-all-changes-saved":!this.hasUnsavedChanges(),"sc-comment-stream-collapsed":S}),j=i.default({"sc-comment-stream-editor-container":this.includeEditorMeatball}),H=i.default({"sc-comment-stream-editor-bundle":this.includeEditorMeatball});let q=null,z=null;const Q=w||D.formatMessage({id:"DkHo17",defaultMessage:"Enter your thoughts here"});if(this.includeEditor)q=n({a11yEditorLabel:Q,author:l,className:"sc-comment-stream-editor",content:this.state.content,placeholder:Q,postSignalComponent:this.renderPostBar,onCancel:this.onPrimaryEditorCancel,setDraftRef:this.setDraftRef,onPost:t,mentionsMatches:h,onMentionsQueryUpdated:e,onFocus:this.onPrimaryEditorFocus,onEditorStateChange:this.onPrimaryEditorStateChange,stickerPacks:U,shouldFocus:L,tagline:s.createElement(y.FirstPartyCommentAdvisory,{thirdPartySource:V,intl:D})});else if(!_){const e=R?"google_doc":V;q=x?null:s.createElement(f.CloudDocMessage,{thirdPartySource:e,openWith:this.props.openWith,intl:D})}return S&&(z=s.createElement(v.Tooltip,{positioning:"left"},s.createElement(g.IconGlobal,{className:"sc-leave-a-comment-button",name:"comment",onClick:this.onLeaveACommentClick}))),s.createElement(A.RawIntlProvider,{value:D},s.createElement(k.CommentStreamContext.Provider,{value:this.state.context},s.createElement("div",{className:B,onClick:this.handleClick},z,s.createElement("div",{className:j},s.createElement("div",{className:H},q,I&&s.createElement(b.CoachmarkLocation,Object.assign({name:b.CoachmarkLocations.ABOVE_COMMENT_STREAM},this.createCoachmarkProps("location"),{positions:this.state.coachmarkPositions}))),this.includeEditorMeatball&&W),N&&0===this.sortedVisibleThreads.length?s.createElement("div",{className:"sc-comment-empty-container"},s.createElement(P.Text,{size:"small",color:"faint"},D.formatMessage(M))):s.createElement(p.UnreadPillWrapper,{showUnreadPill:this.props.showUnreadPill,visibilityData:this.state.visibilityData,countMsgFn:e=>D.formatMessage({id:"fkNHq+",defaultMessage:"{count} unread"},{count:e}),onItemActivated:this.onThreadInteractedWith},s.createElement(C.VisibilityAwareScrollList,{className:"sc-comment-stream-threads",trackedItems:this.state.trackedItems,onVisibilityDataChange:this.onVisibilityDataChange},this.sortedVisibleThreads.map(e=>s.createElement(r.Thread,{ref:t=>this.setThreadRef(e.id,t),key:e.id,actions:this.createThreadActions(e.id),active:e.id===u,focused:e.id===E||e.id===T,commentComponent:a,editedComment:this.state.editedComment,onThreadInteractedWith:this.onThreadInteractedWith,onCancel:this.onThreadReplyCancel,onStartEdit:this.onStartEdit,onEndEdit:this.onEndEdit,isMobile:_,thread:e,user:l,mentionsMatches:h,showRevisionInfo:O,streamSettings:F,stickerPacks:U,thirdPartySource:this.props.thirdPartySource,openWith:this.props.openWith,renderApprovalForm:this.props.renderApprovalForm,approvalFormStatus:this.props.approvalFormStatus})))),I&&s.createElement(b.CoachmarkLocation,Object.assign({name:b.CoachmarkLocations.BELOW_COMMENT_STREAM},this.createCoachmarkProps("location"),{positions:this.state.coachmarkPositions})))))}}t.CommentStream=R,R.childContextTypes={localization:h.default.object,useV2Design:h.default.bool,showApproval:h.default.bool},R.displayName="CommentStream"}));
//# sourceMappingURL=comment_stream.amd.min.js-vflsMnDfC.map