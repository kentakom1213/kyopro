define(["require","exports","api_v2/redux/file_viewer","typescript/libraries/file-viewer/src/watermarking/plugin/utils/index","typescript/libraries/file-viewer/src/watermarking/plugin/selectors","typescript/libraries/file-viewer/src/core/logging/constants","typescript/libraries/file-viewer/src/core/extension_constants","typescript/libraries/file-viewer/src/core/utils/index"],(function(e,r,t,a,i,n,o,l){"use strict";Object.defineProperty(r,"__esModule",{value:!0}),r.reloadWatermarkingHandler=r.analyticsMiddleware=r.handleWatermarkError=r.applyWatermark=void 0,r.applyWatermark=({dispatch:e,getState:r})=>n=>o=>{if("ApplyWatermark"===o.type){const{fileViewerId:n,file:l,overwrite:s}=o.payload,{mode:c,textWatermarkOptions:d,imageWatermarkOptions:p}=r(),f=c[n],g=d[n],m=p[n],u=i.getCurrentWatermarkOptions(n,r()),{position:y,marginX:_,marginY:v}=u,w={path:l.fileId,overwrite:s};if("REPEAT"===y){const{canvas:e,distanceX:r,distanceY:t,startX:i,startY:n,offsetXPerRow:o,offsetYPerCol:l}=a.tilingFunc({scale:g.scale,mode:f,textWatermarkOptions:g,imageWatermarkOptions:m}),s=a.canvasToImage(e);if(null==s)return;w.tiled_image={image:s,distance_x:Math.round(r),distance_y:Math.round(t),start_x:Math.round(i),start_y:Math.round(n),offset_x_per_row:Math.round(o),offset_y_per_col:Math.round(l)}}else{let e;if("text"===f){const{text:r,size:t,scale:i,fontFamily:n,color:o,opacity:l,angle:s}=g;e=a.drawTextTile({text:r,size:t*i,fontFamily:n,color:o,opacity:l,angle:s}).canvas}else{const{image:r,size:t,scale:i,opacity:n,angle:o}=m;if(null==r)return;e=a.drawImageTile({image:r,scale:t*i,opacity:n,angle:o}).canvas}const r=a.canvasToImage(e);if(null==r)return;w.image_watermark={image:r,position:y,margin_x:Math.round(_),margin_y:Math.round(v)}}e(t.watermarkingWatermarkFileAction({arg:w},{fileViewerId:n,fqPath:l.fqPath}))}n(o)},r.handleWatermarkError=e=>()=>r=>i=>{i.type===t.Action.WatermarkingWatermarkFileResult&&i.error&&(i.error=new a.WatermarkingError(e,i.error)),r(i)},r.analyticsMiddleware=e=>({getState:r})=>t=>a=>{if("LogWorkflowEvent"===a.type){const{fileViewerId:t,eventName:i}=a.payload,{file:s,filePreviewSessionId:c}=r().loggingSession[t],d={source_action:n.SourceAction.Click,source_context:n.SourceContext.FileViewer};null!=a.payload.extra&&Object.keys(a.payload.extra).forEach(e=>{if(null!=a.payload.extra){const r=e,t=a.payload.extra[r];null!=t&&(d[r]=t)}}),e.log(i,{file_viewer_session_id:t,file_preview_session_id:c,file_id:null==s?void 0:s.fileId,sj_id:null==s?void 0:s.sjId,ns_id:null==s?void 0:s.nsId,device_type:n.DeviceType.desktop,file_extension:s?o.getWhitelistedFileExtension(l.getFileExtension(s.name)):void 0,extra:d})}t(a)},r.reloadWatermarkingHandler=e=>({})=>r=>a=>{var i;if(a.type===t.Action.WatermarkingWatermarkFileResult&&!a.error&&a.payload.result){const t=r(a),n=a.payload.result.fq_path||(null===(i=a.meta)||void 0===i?void 0:i.fqPath);return e({fqPath:n,overwrite:a.payload.arg.overwrite}),t}return r(a)}}));
//# sourceMappingURL=middlewares.amd.min.js-vfl-hhSDA.map