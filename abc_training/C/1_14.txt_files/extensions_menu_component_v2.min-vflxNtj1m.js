define(["require","exports","tslib","classnames","react","react-redux","dig-components/buttons","dig-components/icons","dig-components/icons/src","dig-components/menu","dig-components/icons/src","spectrum/tooltip/index","modules/clean/file_store/utils","modules/clean/integrations/data/selectors","modules/clean/react/extensions/apis","modules/clean/react/extensions/shared_file_popover_content_component","modules/clean/react/app_actions/telemetry_client","modules/clean/react/components/css","modules/clean/react/extensions/data/action_creators","modules/clean/react/extensions/data/helpers","modules/clean/react/extensions/data/selectors","modules/clean/react/extensions/data/types","modules/clean/react/extensions/extensions_popover_content_component_v2","modules/clean/react/extensions/extensions_utils","modules/clean/react/extensions/file","modules/clean/react/extensions/tooltips","modules/clean/react/file_viewer/constants","modules/clean/react/file_viewer/logging","modules/clean/react/file_viewer/open_button/types","modules/clean/react/file_viewer/unity/with_unity","modules/core/i18n"],(function(e,t,n,o,i,s,r,a,l,c,p,u,d,g,f,h,m,v,y,I,x,S,E,_,C,w,b,T,A,O,P){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.ExtensionsPopoverContent=t.ExtensionsMenuV2=t.ExtensionsMenuV2NoUnity=t.ExtensionsMenuV2Component=void 0,o=n.__importDefault(o),i=n.__importDefault(i);class B extends i.default.Component{constructor(e){super(e),this.handleButtonClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleMenuClick=e=>{e.preventDefault(),e.stopPropagation()},this.handleHover=()=>{this.currentSession&&this.currentSession.event("trigger_hover")},this.setBigTooltip=e=>n.__awaiter(this,void 0,void 0,(function*(){const{file:t,appActions:n,featureFlags:o}=this.props,i=C.getFileExt(t)||"",s=n.length>0;if(s){const t=yield f.getTooltipHistory(e,["open_with_edu"]),n=w.allowedTooltips(s,i,o).find(e=>void 0!==t[e]&&!t[e]);this.setState({bigTooltipName:n})}})),this.markBigTooltipViewed=()=>{let e=!1;const t=[];this.state.bigTooltipName&&(t.push(f.markTooltipViewed(this.props.user.id,this.state.bigTooltipName)),e=!0),e&&(Promise.all(t).then(()=>{this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}),this.setState({bigTooltipName:void 0}))},this.handleSelectAction=(e,t)=>{t.preventDefault(),e.handler(),this.props.onExtensionClick&&this.props.onExtensionClick(e.actionName||e.userAction),this.logToPreviews(e,!1),t.stopPropagation()},this.logToPreviews=(e,t)=>{if(this.props.telemetryContext&&"previews"===this.props.telemetryContext.surface&&e.userAction){const n=t?b.UserActionContext.TitleBarMain:b.UserActionContext.TitleBarSplitButton,o=e.actionName?{app_action_name:e.actionName}:{};d.isBrowseFile(this.props.file)&&this.props.file.read_only&&(o.readOnly=!0),T.logUserAction(e.userAction,n,o)}},this.renderTrigger=e=>{const{triggerType:t}=this.props,n="app-action-open-with-menu__trigger app-action-open-with-menu__trigger-button",o=P.intl.formatMessage({id:"z5t3Bh",defaultMessage:"Open"}),s=t===S.TriggerType.OpacityButton?i.default.createElement(r.Button,Object.assign({variant:"opacity",withDropdownIcon:!0},e),o):t===S.TriggerType.CollapsedButton?i.default.createElement(u.Tooltip,{positionOffset:8,positioning:"left",tooltipContent:P.intl.formatMessage({id:"KEegJt",defaultMessage:"Open With"})},i.default.createElement(r.IconButton,Object.assign({variant:"transparent",className:n},e),i.default.createElement(a.UIIcon,{src:p.OpenLine,"aria-label":o}))):i.default.createElement(r.Button,Object.assign({className:n,variant:t&&t!==S.TriggerType.SecondaryButton?"primary":"opacity"},e),i.default.createElement("div",{className:"app-actions-open-with-menu__trigger-content app-actions-open-with-menu__trigger-content--with-text"},i.default.createElement("div",{className:"app-action-open-with-menu__trigger-button-text"},`${o} â–¾`)));return i.default.createElement("div",Object.assign({onMouseDown:this.markBigTooltipViewed,onMouseEnter:this.handleHover},e),s)},this.renderMenu=()=>i.default.createElement(c.Menu.Wrapper,{className:"app-actions__unportaled-menu",onSelection:this.handleSelectAction,onToggle:this.onPopoverToggle,isPortaled:!0},({getContentProps:e,getTriggerProps:n})=>i.default.createElement(i.default.Fragment,null,this.renderTrigger(n({onClick:this.handleButtonClick})),i.default.createElement(c.Menu.Content,Object.assign({},e({}),{onClick:this.handleMenuClick,className:"app-actions-open-with-menu",placement:"bottom-end"}),i.default.createElement(t.ExtensionsPopoverContent,{user:this.props.user,file:this.props.file,unityInfo:this.props.unityInfo,extraOptions:this.props.extraOptions,sharingServiceInfo:this.props.sharingServiceInfo,refreshSharingServiceInfo:this.props.refreshSharingServiceInfo,onPresentInZoom:this.props.onPresentInZoom,currentSession:this.currentSession,telemetryContext:this.props.telemetryContext})))),this.onPopoverToggle=({isOpen:e})=>{e&&this.props.onDropdownOpen?this.props.onDropdownOpen():!e&&this.props.onDropdownClose&&this.props.onDropdownClose(),this.currentSession&&this.currentSession.event(e?"open_popover":"close_popover")},this.onDownloadClick=e=>t=>{t.preventDefault(),t.stopPropagation(),e.handler(),this.logToPreviews(e,!0)},this.state={},this.telemetryClient=m.createTelemetryClient({component:"menu_v2"})}componentDidMount(){this.props.showBigTooltip&&this.setBigTooltip(this.props.user.id)}render(){const{file:e,appActions:t,featureFlags:n,telemetryContext:s,triggerType:c,showAsButtonIfDownloadOnly:p,hasOpenInPaperSupport:u,unityInfo:g,extraOptions:f,user:h,sharingServiceInfo:v,refreshSharingServiceInfo:y,onPresentInZoom:x,landingPagesEnabled:E,cloudDocsInfo:w}=this.props;if(!e.file_id)return null;s?this.currentSession=this.telemetryClient.session({surface:s.surface,ext:m.getPiiSafeExtension(C.getFileExt(e)||""),feature_flags:n}):delete this.currentSession;const b=_.getOpenOptionsForFile({file:e,hasOpenInPaperSupport:u,unityInfo:g,extraOptions:f,user:h,sharingServiceInfo:v,refreshSharingServiceInfo:y,onPresentInZoom:x,landingPagesEnabled:E,isCloudEditorDisabled:!0,cloudDocsInfo:w,surface:null==s?void 0:s.surface}),T=c===S.TriggerType.CollapsedButton;let O=b.length>0,B=!1;if(O&&1===b.length&&(B=b[0].type===A.OpenButtonAction.DOWNLOAD,O=!B),!O&&(0===t.length||d.isSharedFile(e)&&0===I.partitionActions(t).cloudEditors.length)){if(p&&B){const e={className:o.default("app-actions-download-button",{"app-actions-download-button--collapsed":T}),onClick:this.onDownloadClick(b[0])};return T?i.default.createElement(r.IconButton,Object.assign({variant:"transparent"},e),i.default.createElement(a.UIIcon,{name:"download-file",src:l.DownloadLine,"aria-label":P.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"})})):i.default.createElement(r.Button,Object.assign({variant:"opacity"},e),P.intl.formatMessage({id:"pHnJw0",defaultMessage:"Download"}))}return null}return this.renderMenu()}}t.ExtensionsMenuV2Component=B,B.displayName="ExtensionsMenuV2Component";const D={updateLinkState:(e,t)=>y.updateLinkState({actionId:e,linkState:t}),refreshSharingServiceInfo:y.refreshSharingServiceInfoAdapter},F=s.connect((e,t)=>({appActions:x.getOpenActionsForFile(e,t.file),bylines:x.getBylines(e),categoryInfos:x.getCategoryInfos(e),featureFlags:x.getFeatureFlags(e),cloudDocsInfo:x.getCloudDocInfo(e),landingPagesEnabled:g.isConnectServiceLandingPagesEnabled(e)}),D),M=F(B);t.ExtensionsMenuV2NoUnity=v.requireCssWithComponent(M,["/static/css/app_actions/index-vflb8K3Re.css","/static/css/dig-components/index.web-vflm67Rix.css"]);const k=F(e=>d.isBrowseFile(e.file)?i.default.createElement(O.WithUnity,{file:e.file,user:e.user,render:t=>i.default.createElement(B,Object.assign({},e,{unityInfo:t}))}):i.default.createElement(B,Object.assign({},e)));t.ExtensionsMenuV2=v.requireCssWithComponent(k,["/static/css/app_actions/index-vflb8K3Re.css","/static/css/dig-components/index.web-vflm67Rix.css"]);const N=e=>{const{file:t,user:n,telemetryContext:o,appActions:s,bylines:r,categoryInfos:a,featureFlags:l,updateLinkState:c,hasOpenInPaperSupport:p,unityInfo:u,extraOptions:g,sharingServiceInfo:f,refreshSharingServiceInfo:v,onPresentInZoom:y,landingPagesEnabled:x,cloudDocsInfo:S,isInActionBar:w,previewActionHandler:b,openDesktopActionHandler:T,goToFolderActionHandler:A,isCurrentFolderEligibleForAutomation:O,isSubfolderEligibleForAutomation:P,hideZipAction:B,replayActionHandler:D,openInNewTabActionHandler:F}=e,M=_.getCategoryIdToInfos(a),k=_.getOpenOptionsForFile({file:t,hasOpenInPaperSupport:p,unityInfo:u,extraOptions:g,user:n,sharingServiceInfo:f,refreshSharingServiceInfo:v,onPresentInZoom:y,landingPagesEnabled:x,isCloudEditorDisabled:!0,cloudDocsInfo:S,surface:null==o?void 0:o.surface,isInActionBar:w,previewActionHandler:b,openDesktopActionHandler:T,goToFolderActionHandler:A,isCurrentFolderEligibleForAutomation:O,isSubfolderEligibleForAutomation:P,hideZipAction:B,replayActionHandler:D,openInNewTabActionHandler:F}),N=o&&(e.currentSession||m.createTelemetryClient({component:"menu_v2"}).session({surface:o.surface,ext:m.getPiiSafeExtension(C.getFileExt(t)||""),feature_flags:l}));if(d.isBrowseFile(t)&&(s.length>0||k.length>0))return i.default.createElement(E.ExtensionsPopoverV2WithUnity,{file:t,user:n,openOptions:k,appActions:s,bylines:r,categoryIdToInfos:M,featureFlags:l,updateLinkState:c,telemetryContext:o,currentSession:N,isInActionBar:w});if(d.isSharedFile(t)){const{cloudEditors:e}=I.partitionActions(s);return i.default.createElement(h.SharedFilePopoverContent,{openOptions:k,cloudEditorAppActions:e,file:t,user:n,currentSession:N,isInActionBar:w})}return null};N.displayName="ExtensionsPopoverContentController",t.ExtensionsPopoverContent=F(N)}));
//# sourceMappingURL=extensions_menu_component_v2.min.js-vflZPSlgZ.map