define(["require","exports","tslib","modules/clean/deprecated_ajax/ajax_jquery","lodash","modules/core/i18n","modules/core/cookies","modules/core/notify","modules/core/uri","api_v2/transport/fetch","modules/clean/react/components/modal","modules/clean/react/extensions/auth_modal","modules/clean/filepath/filepath","modules/clean/react/extensions/cloud_docs_compat","modules/clean/cloud_docs/event_logging","modules/clean/cloud_docs/open_with_utils"],(function(e,t,i,o,r,n,d,c,a,s,l,u,_,h,f,p){"use strict";function m(e,t,o){return i.__awaiter(this,void 0,void 0,(function*(){const i=new s.FetchAsyncTransport,r=new a.URI({scheme:"https",authority:"www.dropbox.com",path:"/2/app_actions/"+t}),n={};n["X-Dropbox-Path-Root"]=e.root_ns_id.toString(),n["X-Dropbox-Uid"]=e.id.toString();const c=d.Cookies.read("__Host-js_csrf");if(!c)throw new Error("No CSRF cookie");return(n["X-CSRF-Token"]=c,i.executeRpc(r,n,JSON.stringify(o),"application/json"))}))}function w(e,t,o){return i.__awaiter(this,void 0,void 0,(function*(){const i=yield m(e,t,o),r={request_id:i.headers["x-dropbox-request-id"],redirect_url:i.result.redirect_url};return"link_state"in i.result&&(r.link_state=i.result.link_state),r}))}function g(e,t,o,r,n){return i.__awaiter(this,void 0,void 0,(function*(){yield x(e,t,o,r[0],()=>w(e,"redirect",{action_id:t,file_ids:r}),n)}))}function v(e,t){if(1!==e.length)throw new Error(`Expected single file: ${t}`);return e[0]}function y(e,t,o,r,n){return i.__awaiter(this,void 0,void 0,(function*(){return yield x(e,t,o,r,()=>w(e,"authorize",{action_id:t,file_id:r}),n)}))}function x(e,t,d,a,s,l){return i.__awaiter(this,void 0,void 0,(function*(){const u=`action_redirect_${Math.random().toString(16).substring(2)}`,_=window.open("",u,l);_&&(_.document.open("text/html","replace"),_.document.write(`<html><head><title>${r.escape(d)}</title></head></html>`),_.document.close());let h=!1;const f=new Promise(i=>{o.SilentBackgroundRequest({url:"/aa/loading",subject_user:e.id,data:{file_id:a,action_id:t},success:e=>{!h&&_?(_.document.open("text/html","replace"),_.document.write(e),_.document.close(),_.document.title=d,i()):i()},error:()=>{i()}})});const[,p]=yield Promise.all([f,(function(){return i.__awaiter(this,void 0,void 0,(function*(){try{return yield s()}catch(e){return void(h=!0)}}))})()]),m=p&&p.redirect_url||"/aa/error";if(_)_.location.replace(m);else{if(!window.open(m,"_blank",l)){const e=d;c.Notify.error(n.intl.formatMessage({id:"TFhSer",defaultMessage:"Failed to open {app_name}"},{app_name:e}))}}return p}))}Object.defineProperty(t,"__esModule",{value:!0}),t.showLoadingPageAndDoRedirect=t.authAction=t.redirectToActionOrShowAuth=t.redirectToAction=t.authorizeNoRedirect=t.fetchUrl=t.fetch=void 0,o=i.__importStar(o),r=i.__importStar(r),_=i.__importStar(_),t.fetch=m,t.fetchUrl=w,t.authorizeNoRedirect=function(e,t){return i.__awaiter(this,void 0,void 0,(function*(){try{const i=yield m(e,"authorize_no_redirect",{action_id:t});return i&&i.result&&i.result.link_state}catch(e){return null}}))},t.redirectToAction=g,t.redirectToActionOrShowAuth=function(e,t,o,r,n,d,c){return i.__awaiter(this,void 0,void 0,(function*(){if("redirect"===o.handler[".tag"]){const r=o.handler.window_params;let n=void 0;if("popup"===r[".tag"]){const{width:e,height:t}=r;n=`width=${e},height=${t}`}if("sfa_unlinked"===o.link_state[".tag"]&&!o.id.startsWith("fp_action_id:")){const r=v(t,"first party actions do not support multiple files yet."),c=_.filename(r.ns_path);u.showAuthModal(o.id,o.description,o.icon.url,r.file_id,c,()=>{l.Modal.close(),(function(e,t,o,r,n,d){i.__awaiter(this,void 0,void 0,(function*(){const i=yield y(e,t,o,r,n);d&&i&&i.link_state&&d(t,i.link_state)}))})(e,o.id,o.description,r.file_id,n,d)})}else{const i=t.map(e=>e.file_id);g(e,o.id,o.description,i,n)}}else if("cloud_editor"===o.handler[".tag"]){const i=v(t,"cloud docs actions do not support multiple files yet."),r=n?f.getActionSourceFromSurface(n.surface):void 0,d=h.cloudEditorNameToParams(o.handler.editor_name);p.openWithCloudEditor(p.fileToOpenWithParams(i),e.id,d,!1,r)}else{if("profile_service"!==o.handler[".tag"])throw new Error(`Unexpected handler "${o.handler[".tag"]}"`);if(c){const i=v(t,"profile service actions do not support multiple files yet.");c(e,i,o)}}}))},t.authAction=y,t.showLoadingPageAndDoRedirect=x}));
//# sourceMappingURL=redirect.min.js-vfl-T92rA.map