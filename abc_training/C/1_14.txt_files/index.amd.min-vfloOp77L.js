define(["require","exports","tslib","react","react-redux","typescript/libraries/file-viewer/src/plugins/types","api_v2/redux/comments2","api_v2/redux/media_addon","typescript/libraries/file-viewer/src/comments2/plugin/layer/index","typescript/libraries/file-viewer/src/comments2/plugin/pane","typescript/libraries/file-viewer/src/comments2/plugin/sidebar_control","typescript/component_libraries/files_components/src/blades/comments/index","typescript/component_libraries/flows/src/components/approval-forms/index","typescript/libraries/file-viewer/src/comments2/plugin/types","typescript/libraries/file-viewer/src/comments2/plugin/snackbar","typescript/libraries/comments2/src/mentions/index","typescript/component_libraries/files_components/src/blades/comments/data/store","typescript/libraries/file-viewer/src/comments2/logging_middleware","typescript/libraries/file-viewer/src/comments2/plugin/navigation_middleware","typescript/component_libraries/files_components/src/blades/comments/data/types","typescript/libraries/file-viewer/src/comments2/plugin/markers","typescript/libraries/file-viewer/src/keyboard/index","ts-keycode-enum","typescript/libraries/comments2/src/components/utils/thread_utils","typescript/libraries/file-viewer/src/core/extension_constants","typescript/libraries/file-viewer/src/core/utils/index"],(function(e,t,i,s,r,n,o,a,l,d,c,p,h,m,u,f,g,v,I,C,b,_,y,w,x,A){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Comments2Plugin=t.DEFAULT_COMMENTS_CONFIGURATION=t.MentionsIOClient=void 0,s=i.__importStar(s),Object.defineProperty(t,"MentionsIOClient",{enumerable:!0,get:function(){return f.MentionsIOClient}}),t.DEFAULT_COMMENTS_CONFIGURATION={showCommentsMeatball:!1,isInBladeRightRail:!1,showApproval:!1};t.Comments2Plugin=class{constructor(e,f,O={},E){this.didRequestComments=!1,this.didRequestfocus=!1,this.didRequestActivateThread=!1,this.loadMediaFeatures=()=>i.__awaiter(this,void 0,void 0,(function*(){try{const e=yield this.platform.apiv2ClientBase.ns("media_addon").rpc("get_features",void 0,{});this.store.dispatch(a.getFeaturesResultAction({result:e,arg:void 0}));const t=e.frame_precise_comments;null!=t&&this.context.getPluginData().navigation.toggleVideoFrameSteppers(t)}catch(e){this.store.dispatch(a.getFeaturesResultAction({arg:void 0},null,e))}})),this.isSupported=e=>x.resolvePreviewTypeFromExtension(A.getFileExtension(e.name))!==n.PreviewType.CloudDoc,this.handleCancelAnnotating=()=>{this.store.getState().annotationState&&this.store.dispatch(p.cancelAnnotating(this.context.fileViewerId))},this.layerUI={LayerWithEventBubbling:e=>s.createElement(r.Provider,{store:this.store},s.createElement(l.AnnotationLayer,Object.assign({platform:this.platform,context:this.context,config:this.config},e)))},this.rightRailUI={Control:e=>{var t,i;return e.file&&this.isSupported(e.file)?this.config.isInBladeRightRail?s.createElement(r.Provider,{store:this.store},s.createElement(p.CollapsedCommentsBladeButton,{id:m.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:null===(t=e.file)||void 0===t?void 0:t.fileId,sharedLinkURL:null===(i=e.sharedLinkInfo)||void 0===i?void 0:i.url})):s.createElement(r.Provider,{store:this.store},s.createElement(c.CommentsPluginSidebarControl,Object.assign({platform:this.platform,context:this.context,config:this.config},e))):null},Header:()=>{const e=this.context.getPluginData().previewType;return s.createElement(r.Provider,{store:this.store},s.createElement(u.AnnotationSnackbar,{fileViewerId:this.context.fileViewerId,previewType:e}))},VideoSeekBarLayer:e=>s.createElement(r.Provider,{store:this.store},s.createElement(b.CommentMarkers,Object.assign({},e))),Sidebar:e=>{var t;if(!this.isSupported(e.file))return null;if(this.config.isInBladeRightRail){const i=()=>{var t;null===(t=this.approvalIOClient)||void 0===t||t.getLogger().logRequestApprovalClick(e.file.sjId,e.file.nsId,A.getFileExtension(e.file.name),e.file.fqPath,e.file.fileId)};return s.createElement(r.Provider,{store:this.store},s.createElement(_.KeyboardBindingConnector,{keyboardBindings:this.keybinding}),s.createElement(p.CommentsBlade,{id:m.COMMENTS_PLUGIN_ID,intl:this.platform.intl,fileId:e.file.fileId,sharedLinkURL:null===(t=e.sharedLinkInfo)||void 0===t?void 0:t.url,showApproval:this.config.showApproval,approvalsLogger:i},s.createElement(d.CommentsPluginPane,Object.assign({getAccountData:this.promisedAccount,intl:this.platform.intl,context:this.context,config:this.config,approvalIOClient:this.approvalIOClient},e))))}return s.createElement(r.Provider,{store:this.store},s.createElement(d.CommentsPluginPane,Object.assign({getAccountData:this.promisedAccount,intl:this.platform.intl,context:this.context,config:this.config,approvalIOClient:this.approvalIOClient},e)))},mediaScrubber:{onClickOutsideMarkers:()=>{this.store.dispatch(p.deactivateAllThreads({fileViewerId:this.context.fileViewerId}))},markers:(e,t)=>{const i=this.store.getState().threads[C.createCommentFileIdentifier(e,t)];return i?Object.values(i).reduce((i,s)=>{const r=(function(e){var t;switch(null===(t=e.annotation)||void 0===t?void 0:t.type){case"audio":case"video":return e.annotation.time;default:return}})(s);return void 0===r?i:[...i,{time:r,onClick:()=>{this.store.dispatch(p.activateThread({fileId:e,sharedLinkURL:t,fileViewerId:this.context.fileViewerId,isThirdParty:s.isThirdParty,threadId:s.id}))}}]},[]):[]}}},this.lifecycle={previewWillInitialize:(e,t,i)=>{if(this.didRequestComments=!1,"fileId"in e){if(t){const e={include_permissions:!0,stream:{identifier:{".tag":"shared_link_details",url:t.url},type:{".tag":"file"}}};i?this.store.dispatch(o.loggedOutListCommentsAction({arg:e})):this.store.dispatch(o.listCommentsAction({arg:e}))}else this.store.dispatch(o.listCommentsAction({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:e.fileId},type:{".tag":"file"}}}}));this.didRequestComments=!0}},previewDidInitialize:({threadId:e,shouldFocusApproval:t,shouldFocusComment:i,commentId:s})=>{const{file:r,sharedLinkInfo:a}=this.context.getPluginData();if(null==r)throw new Error("Expected non-null file when preview initialized");if(this.didRequestComments||(this.store.dispatch(o.listCommentsAction({arg:{include_permissions:!0,stream:{identifier:{".tag":"file_path_or_id",file_path_or_id:r.fileId},type:{".tag":"file"}}}})),this.didRequestComments=!0),"string"!=typeof e||this.didRequestActivateThread){if("string"==typeof s&&!this.didRequestActivateThread){this.context.getPluginData().navigation.openSidebar(n.UserActionContext.Sidebar);const e=(null==a?void 0:a.url)||r.fileId,t=Object.values(this.store.getState().threads[e]),i=w.findCommentThread(t,s);i&&this.store.dispatch(p.activateThread({fileId:r.fileId,sharedLinkURL:null==a?void 0:a.url,fileViewerId:this.context.fileViewerId,threadId:i.thread.id,isThirdParty:i.thread.isThirdParty})),this.didRequestActivateThread=!0}}else this.context.getPluginData().navigation.openSidebar(n.UserActionContext.Sidebar),this.store.dispatch(p.activateInitialThread({fileViewerId:this.context.fileViewerId,threadId:e,fileId:r.fileId})),this.didRequestActivateThread=!0;t&&this.store.dispatch(h.setApprovalForm({[r.fileId]:{activeForm:"request",threadId:void 0}})),i&&!this.didRequestfocus&&(this.context.getPluginData().navigation.openSidebar(n.UserActionContext.Sidebar),this.store.dispatch(p.focusEditor(this.context.fileViewerId)),this.didRequestfocus=!0)},previewWillTeardown:()=>{null!=this.store.getState().annotationState&&this.store.dispatch(p.cancelAnnotating(this.context.fileViewerId))}};const P=I.createMiddleware(f);this.store=g.makeStore({apiv2ClientBase:e.apiv2ClientBase,boltIOClient:E.boltIOClient,mentionsIOClient:E.mentionsIOClient,logger:e=>{f.logUserAction({action:e.event,context:"right_sidebar"})}},[P,v.middleware]),this.platform=e,this.context=f,this.config=Object.assign(Object.assign({},t.DEFAULT_COMMENTS_CONFIGURATION),O),this.approvalIOClient=E.approvalIOClient,this.keybinding=_.getKeyboardBinding({keyCode:y.Key.Escape,callback:this.handleCancelAnnotating}),this.promisedAccount=e.apiv2ClientBase.ns("users").rpc("get_current_account",void 0,{}),this.loadMediaFeatures()}}}));
//# sourceMappingURL=index.amd.min.js-vfl3LL3S1.map