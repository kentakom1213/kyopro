define(["require","exports","tslib","react","classnames","spectrum/tertiary_link/index","typescript/libraries/comments2/src/components/comment/index","typescript/libraries/comments2/src/components/thread/third_party_reply_cta","typescript/libraries/comments2/src/components/thread/thread_editor","typescript/libraries/comments2/src/components/thread/thread_source_message","prop-types","typescript/libraries/comments2/src/components/comment_editor/draft_utils","typescript/libraries/comments2/src/components/comment_utils","typescript/libraries/dbx-i18n/src/index","typescript/libraries/comments2/src/components/thread/thread_control_v2","dig-components/buttons","dig-components/icons","dig-components/icons/src","dig-components/tooltips","typescript/libraries/comments2/src/components/utils/approval_utils"],(function(e,t,s,o,i,n,r,a,d,l,c,h,m,p,u,v,g,E,f,M){"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.Thread=void 0,o=s.__importStar(o),i=s.__importDefault(i),c=s.__importDefault(c);const b=()=>{},y=(e,{localization:{intl:t}})=>{const{count:s}=e;t.formatMessage({id:"xj0qJi",defaultMessage:"{count, plural, one {# comment} other {# comments}}"},{count:s});const i=t.formatMessage({id:"NkhP8O",defaultMessage:"{count} comments"},{count:s});return o.createElement("div",{className:"sc-thread-comment-number"},i)};function C(e,t){return{onDeleted:()=>t.onCommentDeleted(e.id),onEdited:s=>t.onCommentEdited(e.id,s),onMentionsQueryUpdated:t.onMentionsQueryUpdated,onClickAnnotation:t.onClickAnnotation,onClickOlderInfo:t.onClickOlderInfo,onApproverRespond:t.onApproverRespond,onEditApproval:t.onEditApproval,onDeleteApprovalComment:t.onDeleteApprovalComment,onResubmitApprovalFocus:t.onResubmitApprovalFocus}}y.contextTypes={localization:c.default.object};const T={type:"no_details"};class A extends o.PureComponent{constructor(){super(...arguments),this.state={isEditorEmpty:!0,isEditorFocused:!1,shouldFocusThreadEditor:!1},this.ref=null,this.onFocusEditor=()=>this.setState({isEditorFocused:!0}),this.onBlurEditor=()=>{this.isApproval&&this.props.actions.onResubmitApprovalBlur(),this.setState({isEditorFocused:!1})},this.onClick=()=>{const{onThreadInteractedWith:e,thread:t}=this.props;e(t)},this.handleKeyDown=e=>{13===e.which&&this.onClick()},this.onEditorStateChange=e=>{h.hasFocus(e)&&this.props.actions.onEditorFocused(),this.props.actions.onEditorStateChange(e),this.setState({isEditorEmpty:h.contentIsEmpty(e)})},this.setRef=e=>{this.ref=e},this.renderMarkedAsResolved=e=>{const{intl:t}=this,s="with_details"===e.type&&e;let i,n;return s?(i=t.formatMessage({id:"seHweQ",defaultMessage:"Marked as resolved by {name}"},{name:s.resolver.name.display}),n=p.timeSince(t,s.resolvedTimestamp,{displayLocation:"label",displayContext:"standalone"})):(i=t.formatMessage({id:"0FvFw6",defaultMessage:"Marked as resolved"}),n=t.formatMessage({id:"0FvFw6",defaultMessage:"Marked as resolved"})),o.createElement(f.Tooltip,{placement:"top",title:n},o.createElement("div",{className:"sc-thread-controls-resolved-note"},i))},this.getResolvedInfo=({resolvedInfo:e,resolved:t})=>e||(t?T:void 0),this.getCommentControlsV2=()=>{const{thread:e,actions:t,streamSettings:s,active:i,isMobile:n}=this.props,r=this.getResolvedInfo(e);return this.useV2Design&&!r?o.createElement(u.ThreadControlV2,{thread:e,actions:t,streamSettings:s,active:i,isMobile:n,intl:this.intl,showApproval:this.showApproval,isApproval:this.isApproval}):null}}get intl(){return this.context.localization.intl}get useV2Design(){return this.context.useV2Design}get showApproval(){return this.context.showApproval}componentDidMount(){this.props.active&&this.scrollToThread(!1).then(()=>{this.ref&&this.ref.focus()})}componentDidUpdate(e){if(this.props.active&&!e.active){const e=this.props.streamSettings.canComment;this.scrollToThread(e)}else!this.props.active&&e.active&&this.setState({isEditorFocused:!1,shouldFocusThreadEditor:!1})}scrollToThread(e){const{scrollToElem:t}=this.props,s=this.ref;return s&&t?t(s).then(()=>{this.ref&&this.setState({shouldFocusThreadEditor:e})}):Promise.resolve()}get innerRef(){return this.ref}get activeOrEditorHasText(){return this.props.active||!this.state.isEditorEmpty}get className(){const{className:e="",thread:t,isMobile:s,focused:o}=this.props,n=t.resolved||t.resolvedInfo;return i.default(e,{"sc-thread":!0,"sc-thread--right-rail":this.context.useV2Design,"sc-thread-active":this.activeOrEditorHasText,"sc-thread-inactive":!this.activeOrEditorHasText,"sc-thread-read":t.read,"sc-thread-unread":!t.read,"sc-thread-resolved":n,"sc-thread-unresolved":!n,"sc-thread-mobile":s,"sc-thread-focused":o,"sc-thread-editor-is-focused":this.state.isEditorFocused})}get filteredReplies(){return this.props.thread.comments.slice(1).filter(e=>!e.deleted)}get includeEditor(){const{streamSettings:{canShowEditor:e},isMobile:t,thread:{isThirdParty:s},approvalFormStatus:o}=this.props,i=this.showApproval&&this.isApproval;return e&&!t&&!s&&(!i||"request_resubmit"===(null==o?void 0:o.activeForm))}get isDisabled(){return!!this.props.thread.pending}get isApproval(){return M.isApprovalThread(this.props.thread)}renderComment(e,t,s=r.Comment,i,n,a){var d;const{actions:l,editedComment:c,mentionsMatches:h,onStartEdit:p,onEndEdit:u,isMobile:v,showRevisionInfo:g,approvalFormStatus:E,thread:f}=this.props,M=!!c&&e.id===c.id,b=!!(null==E?void 0:E.activeForm)&&E.threadId===f.id&&(null===(d=E.editArgs)||void 0===d?void 0:d.commentId)===e.id,y=!!(null==E?void 0:E.activeForm)&&E.threadId===f.id,T={actions:C(e,l),active:t,annotation:n,comment:e,isEditing:M,onStartEdit:p,onEndEdit:u,mentionsMatches:h,isMobile:v,showRevisionInfo:g,commentControls:a,isLatestReply:i,isEditingApproval:b,isApprovalOpen:y};return t||this.useV2Design?o.createElement(s,Object.assign({},T,{key:e.id})):o.createElement(m.TruncatedComment,{comment:e,key:e.id},e=>o.createElement(s,Object.assign({},T,{comment:e})))}renderReadToggle(){const{intl:e}=this,{actions:t,thread:s}=this.props,i=s.read?t.onMarkAsUnread:t.onMarkAsRead,r=s.read?e.formatMessage({id:"rqoF7x",defaultMessage:"Mark as unread"}):e.formatMessage({id:"3OnFd5",defaultMessage:"Mark as read"});return o.createElement(f.Tooltip,{placement:"top",title:r},o.createElement(n.TertiaryLink,{className:"sc-thread-toggle",onClick:i,disabled:this.isDisabled},r))}renderToplineControls(){const{intl:e,useV2Design:t}=this,{streamSettings:s,isMobile:i,actions:r,thread:a}=this.props,d=this.activeOrEditorHasText;if(i)return null;const l=d&&s.canModifyThreads&&!a.isThirdParty,c=this.getResolvedInfo(a);return c?o.createElement("div",{className:"sc-thread-controls"},this.renderMarkedAsResolved(c),l&&o.createElement(f.Tooltip,{placement:"top",title:e.formatMessage({id:"8bWrbN",defaultMessage:"Restore"})},t?o.createElement(v.IconButton,{variant:"transparent",size:"small",onClick:r.onUnresolve,disabled:this.isDisabled},o.createElement(g.UIIcon,{src:E.RestoreLine,size:"small"})):o.createElement(n.TertiaryLink,{className:"sc-thread-toggle",disabled:this.isDisabled,onClick:r.onUnresolve},e.formatMessage({id:"8bWrbN",defaultMessage:"Restore"})))):l&&!this.useV2Design?o.createElement("div",{className:"sc-thread-controls"},this.renderReadToggle(),o.createElement(f.Tooltip,{placement:"top",title:e.formatMessage({id:"g5XGac",defaultMessage:"Resolve"})},o.createElement(n.TertiaryLink,{className:"sc-thread-toggle",onClick:r.onResolve,disabled:this.isDisabled},e.formatMessage({id:"g5XGac",defaultMessage:"Resolve"})))):null}renderActive(){const{intl:e}=this,{actions:{onMentionsQueryUpdated:t,onMouseEnter:s,onMouseLeave:i,onReply:n,onResubmitApprovalRequest:l},commentComponent:c,mentionsMatches:h,stickerPacks:m,onCancel:p,openWith:u,thirdPartySource:v,thread:g,user:E,renderApprovalForm:f}=this.props,y=this.filteredReplies,C=M.getApproverDisplayName(g);return o.createElement("li",{onMouseEnter:s,onMouseLeave:i,className:this.className,tabIndex:0,role:"button","aria-expanded":!0,"aria-label":g.read?e.formatMessage({id:"/pyeDm",defaultMessage:"Comment thread"}):e.formatMessage({id:"vFb6Ur",defaultMessage:"Unread comment thread"}),ref:this.setRef,onClick:this.onClick},this.renderToplineControls(),o.createElement("ul",{className:"sc-thread-comments"},this.renderComment(g.comments[0],this.activeOrEditorHasText,c,0===y.length,g.annotation,this.getCommentControlsV2()),y.map((e,t)=>this.renderComment(e,!0,r.Comment,t===y.length-1)),this.showApproval&&f&&f(["respond","response_edit","request_edit"])),this.includeEditor&&(this.showApproval&&this.isApproval?o.createElement(d.ThreadEditor,{author:E,disabled:this.isDisabled,shouldFocus:this.state.shouldFocusThreadEditor,mentionsMatches:{},onCancel:p,onEditorStateChange:this.onEditorStateChange,onMentionsQueryUpdated:b,onPost:e=>{const t={type:"approval",status:"pending",approval_type:"request",actor:"requester",approver_display_name:C};l({text:e.text,metadata:[t]})},onFocus:this.onFocusEditor,onBlur:this.onBlurEditor,postLabel:e.formatMessage({id:"62bfQA",defaultMessage:"Resubmit request"}),placeholder:e.formatMessage({id:"CqEWQQ",defaultMessage:"Respond to {approver}"},{approver:C}),mentionsDisabled:!0}):o.createElement(d.ThreadEditor,{author:E,disabled:this.isDisabled,shouldFocus:this.state.shouldFocusThreadEditor,mentionsMatches:h,onCancel:p,onEditorStateChange:this.onEditorStateChange,onMentionsQueryUpdated:t,onPost:n,onFocus:this.onFocusEditor,onBlur:this.onBlurEditor,stickerPacks:m})),o.createElement(a.ThirdPartyReplyCTA,{intl:e,thirdPartySource:g.isThirdParty?v:void 0,openWith:u}))}renderInactive(){const{intl:e}=this,{actions:{onMouseEnter:t,onMouseLeave:s,onFocus:i,onBlur:n},active:a,commentComponent:d=r.Comment,mentionsMatches:c,thread:h,isMobile:p,showRevisionInfo:u,thirdPartySource:v}=this.props,g=this.filteredReplies;return o.createElement("li",{className:this.className,tabIndex:0,"aria-label":h.read?e.formatMessage({id:"/pyeDm",defaultMessage:"Comment thread"}):e.formatMessage({id:"vFb6Ur",defaultMessage:"Unread comment thread"}),role:"button","aria-expanded":!1,onClick:this.onClick,onKeyDown:this.handleKeyDown,onMouseEnter:t,onMouseLeave:s,onFocus:i,onBlur:n,ref:this.setRef},this.renderToplineControls(),o.createElement("ul",{className:"sc-thread-comments"},this.renderComment(h.comments[0],a,d,0===g.length,h.annotation),g.length>1&&o.createElement(y,{count:g.length-1}),g.length>0&&(this.useV2Design?o.createElement(r.Comment,{active:!1,comment:g[g.length-1],actions:{onClickAnnotation:b,onDeleted:b,onEdited:b,onMentionsQueryUpdated:b,onClickOlderInfo:b,onApproverRespond:b,onResubmitApprovalFocus:b},mentionsMatches:c,onEndEdit:b,onStartEdit:b,isEditing:!1,isMobile:p,showRevisionInfo:u,isLatestReply:!0,isEditingApproval:!1}):o.createElement(m.TruncatedComment,{comment:g[g.length-1]},e=>o.createElement(r.Comment,{active:!1,comment:e,actions:{onClickAnnotation:b,onDeleted:b,onEdited:b,onMentionsQueryUpdated:b,onClickOlderInfo:b,onApproverRespond:b,onResubmitApprovalFocus:b},mentionsMatches:c,onEndEdit:b,onStartEdit:b,isEditing:!1,isMobile:p,showRevisionInfo:u,isLatestReply:!0,isEditingApproval:!1})))),this.includeEditor&&!this.useV2Design&&o.createElement("div",{className:"sc-thread-reply-hint"},e.formatMessage({id:"cBx2hi",defaultMessage:"Reply…"})),o.createElement(l.ThreadSourceMessage,{thirdPartySource:h.isThirdParty?v:void 0,intl:e}))}render(){return this.props.thread.comments.every(e=>!!e.deleted)?null:this.activeOrEditorHasText?this.renderActive():this.renderInactive()}}t.Thread=A,A.contextTypes={localization:c.default.object,useV2Design:c.default.bool,showApproval:c.default.bool},A.displayName="Thread"}));
//# sourceMappingURL=thread.amd.min.js-vflKgHJ1R.map